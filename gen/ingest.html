<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Ingest, origin supplied</title>
    <link rel="stylesheet" href="../seq.css" />
    <script src="https://cdn.rawgit.com/knsv/mermaid/0.4.0/dist/mermaid.full.js"></script>
    <script>
        var mermaid_config = {
            startOnLoad:true,
            htmlLabels:true
        }
        mermaid.sequenceConfig = {
            diagramMarginX:50,
            diagramMarginY:10,
            boxTextMargin:5,
            noteMargin:10,
            messageMargin:35,
            mirrorActors:true,
            width:150,
            // Height of actor boxes
            height:30
        };
    </script>
</head>
<body>

<div class="mermaid">
sequenceDiagram
    Customer->>API: POST /images/customer/
    Note right of Customer: JSON document,<br/>like info.json<br/>No binary payload
    Note right of API: Ingest is async<br/>Pulled from queue
    API->>ImageService: Ingest    
    alt If 'immediate'
        ImageService->>Customer: GET /origin
        ImageService->>kdu_exe: Convert to JP2
        Note right of ImageService: Save to SCRATCH EFS
        ImageService->>kdu_exe: MakeThumbnails
        Note right of kdu_exe: Bound by 100, by 400<br/>Save to Customer S3
        ImageService->>ImageServerNode: GET /../info.json
        ImageService->>DynamoDB: (Write entry)
        opt If 'Keep'
            ImageService->>S3: Save JP2
        end
    else Deferred
        ImageService->>DynamoDB: Write placeholder
        Note right of ImageService: This is an unseen image<br/>Use w,h from customer<br/>Leave info.json blank
    end
</div>

<script>

    if(location.search.indexOf('nav') != -1)
    {
        document.write('<hr/><p><a href="../index.html">Return to list of diagrams</a><br/>');
	document.write('<a href="../png/ingest.png">PNG version</a></p>');	
    }

</script>
</body>
</html>
